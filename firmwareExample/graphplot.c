/*
 * Copyright (C) 2021 Technische Universit√§t Berlin
 *
 * This file is subject to the terms and conditions of the GNU Lesser
 * General Public License v2.1. See the file LICENSE in the top level
 * directory for more details.
 */

/**
 * @ingroup     firmwareExample
 * @{
 *
 * @file
 * @brief       Graph Plotting
 *
 * @author      Jan Mohr <jan.mohr@campus.tu-berlin.de>
 *
 * @}
 */

#include <stdio.h>
#include "pcd8544.h"
#include "graphplot.h"

/* debug config */
#define ENABLE_DEBUG 0
#include "debug.h"

static int16_t y_value_min = 0;
static int16_t y_value_max = 0x7FFF;

static uint8_t graph_mode = 0;

static uint8_t pixel_save[PCD8544_RES_X][PCD8544_ROWS] = {{0x00}};

static const uint8_t graph_img_0[] = {
    0x84,0x82,0xFF,0x02,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

    0x80,0x80,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

    0x80,0x80,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

    0x80,0x80,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

    0x80,0x80,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

    0x00,0x00,0x3F,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0xE0,0x20,
    0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0xE0,0x20,0x20,0x20,0x20,0x20,
    0x20,0x20,0x20,0x20,0xE0,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,
    0xE0,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0xE0,0x20,0x20,0x20,
    0x20,0x20,0x20,0x20,0x20,0x20,0xE0,0x20,0x20,0x20,0x20,0x20,0x20,0x20,
    0x20,0x20,0xE0,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0xA8,0x70,0x20,
};

static const uint8_t graph_img_1[] = {
    0x84,0x82,0xFF,0x02,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

    0x80,0x80,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

    0x80,0x80,0xFF,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,
    0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,
    0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,
    0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,
    0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,
    0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0xA0,0xC0,0x80,

    0x80,0x80,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x01,0x00,

    0x80,0x80,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

    0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
};

void graphplot_clear(void) {
    for (uint8_t x = 0; x < PCD8544_RES_X; x++) {
        for (uint8_t y_line = 0; y_line < PCD8544_ROWS; y_line++){
            pixel_save[x][y_line] = 0x00;
        }
    }
}

void graphplot_write_pixel(const pcd8544_t *dev, uint8_t x, uint8_t y) {
    /* check position */
    if (x >= PCD8544_RES_X || y >= PCD8544_RES_Y) {
        return;
    }

    /* calc y position */
    uint8_t y_line = y / 8;

    /* check pixel array */
    pixel_save[x][y_line] = pixel_save[x][y_line] | (1 << (y % 8));

    /* write stackedpixel */
    pcd8544_write_stackedpixel(dev, x, y_line, pixel_save[x][y_line]);
}

void graphplot_clear_pixel(const pcd8544_t *dev, uint8_t x, uint8_t y) {
    /* check position */
    if (x >= PCD8544_RES_X || y >= PCD8544_RES_Y) {
        return;
    }

    /* calc y position */
    uint8_t y_line = y / 8;

    /* check pixel array */
    pixel_save[x][y_line] = pixel_save[x][y_line] & ~(1 << (y % 8));

    /* remove stackedpixel */
    pcd8544_clear_stackedpixel(dev, x, y_line, pixel_save[x][y_line]);
}

void graphplot_diagram(const pcd8544_t *dev, uint8_t mode) {
    uint8_t x, y_line;

    /* store current mode of graph */
    graph_mode = mode;

    if (mode == 0) {
        /* store graph_img in pixel_save */
        for (unsigned i = 0; i < (PCD8544_RES_X * PCD8544_RES_Y / 8); i++) {
            y_line = i / PCD8544_RES_X;
            x = i - (PCD8544_RES_X * y_line);
            pixel_save[x][y_line] = graph_img_0[i];
        }
        pcd8544_write_img(dev, graph_img_0);
    }

    else if (mode == 1) {
        /* store graph_img in pixel_save */
        for (unsigned i = 0; i < (PCD8544_RES_X * PCD8544_RES_Y / 8); i++) {
            y_line = i / PCD8544_RES_X;
            x = i - (PCD8544_RES_X * y_line);
            pixel_save[x][y_line] = graph_img_1[i];
        }

        pcd8544_write_img(dev, graph_img_1);
    }

    else {
        graph_mode = 0;
        return;
    }
}

void graphplot_set_min_max(int16_t min, int16_t max) {
    /* check if value max is bigger than min and not equal */
    if (graph_mode == 0) // mode with first quadrant
        assert(max > min && max != -min);
    if (graph_mode == 1) // mode with first and second quadrant
        assert(max > min && max == -min);

    y_value_min = min;
    y_value_max = max;
}

void graphplot_write_coordinate(const pcd8544_t *dev, uint8_t x_coordinate, int16_t y_coordinate) {
    /* check if in range */
    if (y_coordinate >= y_value_max)
        y_coordinate = y_value_max;
    if (y_coordinate <= y_value_min)
        y_coordinate = y_value_min;

    /* save y_coordinate and sign of y_value */
    bool neg_sign = false;
    uint64_t y_value = 0;
    y_value = y_coordinate;
    if (y_coordinate < 0){
        neg_sign = true;
        y_value = y_coordinate * (-1);
    }

    /* y-axis parameter */
    uint8_t axis_range = PCD8544_RES_Y - 1 - GRAPHPLOT_OFFSET_Y;
    uint32_t value_range = (y_value_max - y_value_min);
    uint32_t multiplier = 0x4000;

    y_value = (y_value * axis_range * multiplier) / value_range;

    /* restore y_value */
    uint8_t y = y_value / multiplier;

    if (graph_mode == 0)
        y = (-1) * y + axis_range;
    else if (graph_mode == 1) {
        if (neg_sign)
            y = y + axis_range / 2;
        else
            y = (-1) * y + axis_range / 2;
    }
    
    /* check position */
    if (x_coordinate >= PCD8544_RES_X || y >= PCD8544_RES_Y) {
        return;
    }

    /* calc y position */
    uint8_t y_line = y / 8;

    /* check pixel array */
    pixel_save[x_coordinate][y_line] = pixel_save[x_coordinate][y_line] | (1 << (y % 8));

    /* write stackedpixel */
    pcd8544_write_stackedpixel(dev, x_coordinate, y_line, pixel_save[x_coordinate][y_line]);
}
